# broker-interceptor Environment Variables Example
# Copy this file to .env and adjust values as needed

# ============================================
# Shared Infrastructure
# ============================================
# These are the default values for local Docker Compose setup
# DATABASE_URL and REDIS_URL are used by scripts and can be overridden per-service

# Runtime mode used by Docker Compose app containers.
# Keep this as development for local/CI smoke runs.
BROKER_RUNTIME_ENV=development

# Local infra credentials/ports (used by docker-compose + scripts).
BROKER_POSTGRES_USER=broker
BROKER_POSTGRES_PASSWORD=broker
BROKER_POSTGRES_DB=broker
BROKER_POSTGRES_PORT=5432
BROKER_REDIS_PASSWORD=broker
BROKER_REDIS_PORT=6379

# Container-network URLs (used by docker-compose app profile).
BROKER_ADMIN_API_DATABASE_URL_DOCKER=postgresql://${BROKER_POSTGRES_USER}:${BROKER_POSTGRES_PASSWORD}@postgres:5432/${BROKER_POSTGRES_DB}
BROKER_ADMIN_API_REDIS_URL_DOCKER=redis://:${BROKER_REDIS_PASSWORD}@redis:6379
BROKER_API_DATABASE_URL_DOCKER=postgresql://${BROKER_POSTGRES_USER}:${BROKER_POSTGRES_PASSWORD}@postgres:5432/${BROKER_POSTGRES_DB}
BROKER_API_REDIS_URL_DOCKER=redis://:${BROKER_REDIS_PASSWORD}@redis:6379

# ============================================
# broker-admin-api Configuration
# ============================================

# Server settings
BROKER_ADMIN_API_HOST=0.0.0.0
BROKER_ADMIN_API_PORT=8080

# Infrastructure (database + redis)
BROKER_ADMIN_API_INFRA_ENABLED=true
BROKER_ADMIN_API_DATABASE_URL=postgresql://broker:broker@127.0.0.1:5432/broker
BROKER_ADMIN_API_REDIS_URL=redis://:broker@127.0.0.1:6379
BROKER_ADMIN_API_REDIS_KEY_PREFIX=broker-admin-api:control-plane
BROKER_ADMIN_API_CORS_ALLOWED_ORIGINS=http://localhost:4173

# Authentication (static mode for development)
# Generate tokens: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
BROKER_ADMIN_API_AUTH_MODE=static
BROKER_ADMIN_API_STATIC_TOKENS_JSON='[{"token":"dev-admin-token-change-in-production","subject":"dev-admin","tenant_ids":["*"],"roles":["owner"]}]'

# Secret key for envelope encryption (32 bytes base64 encoded)
# Keep BROKER_ADMIN_API_SECRET_KEY_B64 and BROKER_API_SECRET_KEY_B64 aligned.
# Generate: node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
BROKER_ADMIN_API_SECRET_KEY_B64=YnJva2VyLWRldi1zaGFyZWQtc2VjcmV0LWtleS0zMmI=
BROKER_ADMIN_API_SECRET_KEY_ID=v1

# Certificate issuer (local for Docker Compose mTLS development)
BROKER_ADMIN_API_CERT_ISSUER_MODE=local

# Local certificate issuer (used by default in Docker Compose mTLS development)
# Paths below are container paths used by compose mounts.
BROKER_ADMIN_API_LOCAL_CA_CERT_PATH=/app/certs/ca.crt
BROKER_ADMIN_API_LOCAL_CA_KEY_PATH=/app/certs/ca.key
# Optional override (if omitted, broker-admin-api auto-reads BROKER_ADMIN_API_LOCAL_CA_CERT_PATH)
# BROKER_ADMIN_API_MTLS_CA_PEM=<contents of ca.crt>

# Token TTLs
BROKER_ADMIN_API_ENROLLMENT_TOKEN_TTL_SECONDS=900
BROKER_ADMIN_API_CLIENT_CERT_TTL_SECONDS_MAX=2592000

# Optional: persistent state path (leave empty for in-memory only)
# BROKER_ADMIN_API_STATE_PATH=./data/admin-state.json

# Optional: manifest keys (leave empty for empty keyset)
# BROKER_ADMIN_API_MANIFEST_KEYS_JSON=

# ============================================
# broker-api Configuration
# ============================================

# Server settings
BROKER_API_HOST=0.0.0.0
BROKER_API_PORT=8081
BROKER_API_PUBLIC_BASE_URL=https://broker.example

# Infrastructure (database + redis)
BROKER_API_INFRA_ENABLED=true
BROKER_API_DATABASE_URL=postgresql://broker:broker@127.0.0.1:5432/broker
BROKER_API_REDIS_URL=redis://:broker@127.0.0.1:6379
BROKER_API_REDIS_KEY_PREFIX=broker-api:data-plane
BROKER_API_CORS_ALLOWED_ORIGINS=http://localhost:4173

# Session and timeout settings
BROKER_API_SESSION_DEFAULT_TTL_SECONDS=900
BROKER_API_APPROVAL_TTL_SECONDS=300
BROKER_API_MANIFEST_TTL_SECONDS=300
BROKER_API_DPOP_MAX_SKEW_SECONDS=300

# Forwarder settings
BROKER_API_FORWARDER_TOTAL_TIMEOUT_MS=15000
BROKER_API_FORWARDER_MAX_REQUEST_BODY_BYTES=2097152
BROKER_API_FORWARDER_MAX_RESPONSE_BYTES=2097152
BROKER_API_DNS_TIMEOUT_MS=2000

# TLS / mTLS settings (docker-compose local defaults expect certs in apps/broker-api/certs)
BROKER_API_TLS_ENABLED=true
BROKER_API_TLS_KEY_PATH=/run/certs/broker-api/server.key
BROKER_API_TLS_CERT_PATH=/run/certs/broker-api/server.crt
BROKER_API_TLS_CLIENT_CA_PATH=/run/certs/broker-api/ca.crt
BROKER_API_TLS_REQUIRE_CLIENT_CERT=true
BROKER_API_TLS_REJECT_UNAUTHORIZED_CLIENT_CERT=false
BROKER_API_SECRET_KEY_B64=YnJva2VyLWRldi1zaGFyZWQtc2VjcmV0LWtleS0zMmI=
BROKER_API_SECRET_KEY_ID=v1
# Set true to force local cert rotation on next docker compose up
# BROKER_API_CERTS_FORCE_ROTATE=false
# Rotate if certs expire within N days (default 30)
# BROKER_API_CERTS_RENEW_BEFORE_DAYS=30

# Expected SAN URI prefix for workload certificates
# BROKER_API_EXPECTED_SAN_URI_PREFIX=spiffe://broker/

# Optional: persistent state path (leave empty for in-memory only)
# BROKER_API_STATE_PATH=./data/api-state.json

# ============================================
# OIDC Configuration (production authentication)
# ============================================
# Uncomment and configure for production OIDC authentication

# BROKER_ADMIN_API_AUTH_MODE=oidc
# BROKER_ADMIN_API_OIDC_ISSUER=https://your-idp.example.com
# BROKER_ADMIN_API_OIDC_AUDIENCE=broker-admin-api
# BROKER_ADMIN_API_OIDC_JWKS_URI=https://your-idp.example.com/.well-known/jwks.json
# BROKER_ADMIN_API_OIDC_ROLE_CLAIM=roles
# BROKER_ADMIN_API_OIDC_TENANT_CLAIM=tenant_ids

# ============================================
# Vault Configuration (production certificate issuer)
# ============================================
# Uncomment and configure for production Vault-based certificate issuing

# BROKER_ADMIN_API_CERT_ISSUER_MODE=vault
# BROKER_ADMIN_API_VAULT_ADDR=https://vault.example.com:8200
# BROKER_ADMIN_API_VAULT_TOKEN=
# BROKER_ADMIN_API_VAULT_PKI_MOUNT=pki
# BROKER_ADMIN_API_VAULT_PKI_ROLE=broker-workloads
# BROKER_ADMIN_API_VAULT_REQUEST_TIMEOUT_MS=5000
